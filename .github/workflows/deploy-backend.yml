name: Deploy Backend

on:
  workflow_call:
    inputs:
      environment:
        required: true
        type: string

jobs:
  deploy-backend:
    name: Deploy Backend
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Initialize Node.js project
        run: |
          if [ ! -f package.json ]; then
            echo '{
              "name": "safevote-backend",
              "version": "1.0.0",
              "private": true,
              "scripts": {
                "test": "echo \"No tests specified\" && exit 0"
              },
              "dependencies": {
                "express": "^4.18.2"
              },
              "devDependencies": {
                "jest": "^29.5.0"
              }
            }' > package.json
            echo "Created package.json"
          else
            echo "package.json already exists"
          fi
          
          if [ ! -f package-lock.json ]; then
            npm install --package-lock-only
          fi

      - name: Set up Node.js with cache
        uses: actions/setup-node@v3
        with:
          node-version: '18.x'
          cache: 'npm'
          cache-dependency-path: '**/package-lock.json'

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm test

      - name: Verify required variables
        run: |
          if [ -z "${{ vars.BACKEND_DOWNLOAD_URL }}" ]; then
            echo "::error::BACKEND_DOWNLOAD_URL is not set. Please set it in your repository's variables."
            exit 1
          fi
          if [ -z "$SUT_IP_ADDRESS" ]; then
            echo "::error::SUT_IP_ADDRESS is not set. Please set it in your repository's variables."
            exit 1
          fi

      - name: Deploy backend
        run: |
          chmod +x ./scripts/deploy-backend.sh
          echo "Deploying backend with URL: ${{ vars.BACKEND_DOWNLOAD_URL }}"
          echo "SUT IP: $SUT_IP_ADDRESS"
          echo "Backend Port: $BACKEND_PORT"
          ./scripts/deploy-backend.sh "${{ vars.BACKEND_DOWNLOAD_URL }}" "$SUT_IP_ADDRESS" "$BACKEND_PORT"
