name: Deploy Backend

on:
  workflow_call:
    inputs:
      environment:
        required: true
        type: string
      backend_download_url:
        required: false
        type: string
        default: 'http://localhost:15550'
      sut_ip_address:
        required: false
        type: string
        default: 'localhost'
      backend_port:
        required: false
        type: string
        default: '15550'

jobs:
  deploy-backend:
    name: Deploy Backend
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Initialize Node.js project
        run: |
          if [ ! -f package.json ]; then
            echo '{
              "name": "safevote-backend",
              "version": "1.0.0",
              "private": true,
              "scripts": {
                "test": "echo \"No tests specified\" && exit 0"
              },
              "dependencies": {
                "express": "^4.18.2"
              },
              "devDependencies": {
                "jest": "^29.5.0"
              }
            }' > package.json
            echo "Created package.json"
          else
            echo "package.json already exists"
          fi
          
          if [ ! -f package-lock.json ]; then
            npm install --package-lock-only
          fi

      - name: Set up Node.js with cache
        uses: actions/setup-node@v3
        with:
          node-version: '18.x'
          cache: 'npm'
          cache-dependency-path: '**/package-lock.json'

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm test

      - name: Deploy backend
        run: |
          chmod +x ./scripts/deploy-backend.sh
          echo "Deploying backend with URL: ${{ inputs.backend_download_url }}"
          echo "SUT IP: ${{ inputs.sut_ip_address }}"
          echo "Backend Port: ${{ inputs.backend_port }}"
          ./scripts/deploy-backend.sh "${{ inputs.backend_download_url }}" "${{ inputs.sut_ip_address }}" "${{ inputs.backend_port }}"

