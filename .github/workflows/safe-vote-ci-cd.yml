name: SafeVote CI/CD Pipeline

# Controls when the workflow will run
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'staging'
        type: choice
        options:
        - staging
        - production

env:
  # Required variables with defaults for local testing
  SUT_IP_ADDRESS: ${{ vars.SUT_IP_ADDRESS || 'localhost' }}
  BACKEND_PORT: 15550
  BACKEND_DOWNLOAD_URL: ${{ vars.BACKEND_DOWNLOAD_URL || 'http://localhost:3000' }}
  
  # AWS Configuration
  AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID || 'dummy-key' }}
  AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY || 'dummy-secret' }}
  AWS_REGION: ${{ vars.AWS_REGION || 'us-east-1' }}
  S3_BUCKET: ${{ vars.S3_BUCKET || 'safevote-local' }}
  
  # Environment Configuration
  ENVIRONMENT: ${{ github.event.inputs.environment || 'staging' }}
  TF_BACKEND_BUCKET: ${{ vars.TF_BACKEND_BUCKET || 'safevote-tfstate' }}
  TF_STATE_KEY: "safevote/${{ github.event.inputs.environment || 'staging' }}/terraform.tfstate"
  
  # Frontend Configuration (if using S3)
  S3_FRONTEND_BUCKET: ${{ vars.S3_FRONTEND_BUCKET || 'safevote-frontend' }}

jobs:
  # Security scanning job that runs in parallel
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Fetch all history for dependency check

      # Only run dependency review on pull requests
      - name: Run dependency check
        if: github.event_name == 'pull_request'
        uses: actions/dependency-review-action@v3
        with:
          fail-on-severity: high
          base_ref: ${{ github.event.pull_request.base.sha }}
          head_ref: ${{ github.event.pull_request.head.sha }}

      # Always run OWASP Dependency Check
      - name: Run OWASP Dependency Check
        uses: dependency-check/Dependency-Check_Action@main
        with:
          project: 'SafeVote'
          format: 'HTML'
          fail_on_cvss_above_threshold: '7'
          fail_build: true
          path: './**'
          scanpath: '.'

      - name: Upload dependency scan results
        uses: actions/upload-artifact@v4
        with:
          name: dependency-scan-results
          path: dependency-check-report.*

  # Infrastructure deployment job
  deploy-infrastructure:
    name: Deploy Infrastructure
    needs: security-scan
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'staging' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_wrapper: false

      - name: Terraform Init
        working-directory: ./infra
        run: |
          terraform init \
            -backend-config="bucket=${{ env.TF_BACKEND_BUCKET }}" \
            -backend-config="key=${{ env.TF_STATE_KEY }}" \
            -backend-config="region=${{ env.AWS_REGION }}"

      - name: Terraform Plan
        id: plan
        working-directory: ./infra
        run: |
          terraform plan \
            -var="environment=${{ env.ENVIRONMENT }}" \
            -var="s3_bucket_name=${{ env.ENVIRONMENT }}-safevote-frontend" \
            -out=tfplan

      - name: Terraform Apply
        if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
        working-directory: ./infra
        run: |
          terraform apply -auto-approve tfplan

  deploy-backend:
    name: Deploy Backend
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      # First ensure package.json exists before setting up Node.js
      - name: Initialize Node.js project
        run: |
          if [ ! -f package.json ]; then
            echo '{
              "name": "safevote-backend",
              "version": "1.0.0",
              "private": true,
              "scripts": {
                "test": "echo \"No tests specified\" && exit 0"
              },
              "dependencies": {
                "express": "^4.18.2"
              },
              "devDependencies": {
                "jest": "^29.5.0"
              }
            }' > package.json
            echo "Created package.json"
          else
            echo "package.json already exists"
          fi
          
          # Generate lock file if it doesn't exist
          if [ ! -f package-lock.json ]; then
            npm install --package-lock-only
          fi

      - name: Set up Node.js with cache
        uses: actions/setup-node@v3
        with:
          node-version: '18.x'
          cache: 'npm'
          cache-dependency-path: '**/package-lock.json'

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm test

      - name: Verify required variables
        run: |
          if [ -z "${{ vars.BACKEND_DOWNLOAD_URL }}" ]; then
            echo "::error::BACKEND_DOWNLOAD_URL is not set. Please set it in your repository's variables."
            exit 1
          fi
          if [ -z "$SUT_IP_ADDRESS" ]; then
            echo "::error::SUT_IP_ADDRESS is not set. Please set it in your repository's variables."
            exit 1
          fi

      - name: Deploy backend
        run: |
          chmod +x ./scripts/deploy-backend.sh
          echo "Deploying backend with URL: ${{ vars.BACKEND_DOWNLOAD_URL }}"
          echo "SUT IP: $SUT_IP_ADDRESS"
          echo "Backend Port: $BACKEND_PORT"
          ./scripts/deploy-backend.sh "${{ vars.BACKEND_DOWNLOAD_URL }}" "$SUT_IP_ADDRESS" "$BACKEND_PORT"

  deploy-frontend:
    name: Deploy Frontend
    needs: [deploy-backend, deploy-infrastructure]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18.x'
          cache: 'npm'

      - name: Install dependencies
        run: |
          cd frontend
          npm ci

      - name: Build frontend
        run: |
          cd frontend
          npm run build

      - name: Deploy to S3
        run: |
          chmod +x ./scripts/deploy-frontend.sh
          ./scripts/deploy-frontend.sh frontend/build $S3_BUCKET

  run-tests:
    name: Run Integration Tests
    needs: [deploy-backend, deploy-frontend, deploy-infrastructure]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Robot Framework
        run: |
          python -m pip install --upgrade pip
          pip install robotframework
          pip install robotframework-requests

      - name: Run tests
        run: |
          chmod +x ./scripts/run-tests.sh
          ./scripts/run-tests.sh $SUT_IP_ADDRESS $BACKEND_PORT

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: test-results
          path: test-results/

  validate-deployment:
    name: Validate Deployment
    needs: run-tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Run validation
        run: |
          chmod +x ./scripts/validate-deployment.sh
          ./scripts/validate-deployment.sh $SUT_IP_ADDRESS $BACKEND_PORT

      - name: Upload validation results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: validation-results
          path: validation-results/

  notify-deployment:
    name: Notify Team
    needs: validate-deployment
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Check deployment status
        id: check-status
        run: |
          if [ "${{ needs.deploy-backend.result }}" = "success" ] && \
             [ "${{ needs.deploy-frontend.result }}" = "success" ] && \
             [ "${{ needs.validate-deployment.result }}" = "success" ]; then
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "status=failed" >> $GITHUB_OUTPUT
          fi

      - name: Send Slack notification
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_COLOR: ${{ steps.check-status.outputs.status == 'success' && '#36a64f' || '#ff0000' }}
          SLACK_TITLE: "SafeVote Deployment ${{ steps.check-status.outputs.status == 'success' && '‚úÖ Succeeded' || '‚ùå Failed' }}"
          SLACK_MESSAGE: |
            *Environment*: ${{ env.ENVIRONMENT }}
            *Commit*: ${{ github.sha }}
            *Workflow*: ${{ github.workflow }}
            *Status*: ${{ steps.check-status.outputs.status }}
            *Run URL*: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}

  rollback-on-failure:
    name: Rollback on Failure
    if: failure() && (needs.deploy-backend.result == 'failure' || needs.deploy-frontend.result == 'failure' || needs.validate-deployment.result == 'failure')
    needs: [deploy-backend, deploy-frontend, validate-deployment]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          ref: ${{ github.event.before || 'HEAD~1' }}

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Rollback Backend
        if: needs.deploy-backend.result == 'failure' || needs.deploy-frontend.result == 'failure'
        run: |
          echo "üö® Initiating rollback procedure..."
          
          # Check if we're rolling back from a specific version or last known good
          if [ -n "${{ vars.LAST_KNOWN_GOOD_VERSION }}" ]; then
            echo "Rolling back to last known good version: ${{ vars.LAST_KNOWN_GOOD_VERSION }}"
            # Download and deploy the last known good version
            curl -sL "${{ vars.BACKEND_DOWNLOAD_URL }}/${{ vars.LAST_KNOWN_GOOD_VERSION }}/backend.tar.gz" -o backend-rollback.tar.gz
            tar -xzf backend-rollback.tar.gz -C /tmp/safevote-backend --strip-components=1
            systemctl restart safevote-backend
            echo "‚úÖ Backend rolled back to version ${{ vars.LAST_KNOWN_GOOD_VERSION }}"
          else
            # Fallback to previous deployment
            echo "No specific version to rollback to, redeploying previous version..."
            systemctl stop safevote-backend || true
            systemctl start safevote-backend || systemctl restart safevote-backend
            echo "‚úÖ Backend service restarted"
          fi

      - name: Rollback Frontend
        if: needs.deploy-frontend.result == 'failure' || needs.deploy-backend.result == 'failure'
        run: |
          echo "üîÑ Rolling back frontend to previous version..."
          # If using S3 for frontend hosting with versioning
          if [ -n "${{ vars.S3_FRONTEND_BUCKET }}" ]; then
            PREVIOUS_VERSION=$(aws s3api list-object-versions \
              --bucket ${{ vars.S3_FRONTEND_BUCKET }} \
              --prefix index.html \
              --query 'Versions[?IsLatest==`false`] | [0].VersionId' \
              --output text)
            
            if [ "$PREVIOUS_VERSION" != "None" ]; then
              echo "Restoring previous version: $PREVIOUS_VERSION"
              aws s3api copy-object \
                --copy-source "${{ vars.S3_FRONTEND_BUCKET }}/index.html?versionId=$PREVIOUS_VERSION" \
                --bucket ${{ vars.S3_FRONTEND_BUCKET }} \
                --key index.html \
                --metadata-directive COPY
              echo "‚úÖ Frontend rolled back to previous version"
            else
              echo "‚ö†Ô∏è No previous version found for rollback"
            fi
          else
            echo "‚ÑπÔ∏è No S3 frontend bucket configured for rollback"
          fi

      - name: Verify Rollback
        if: always() && (needs.deploy-backend.result == 'failure' || needs.deploy-frontend.result == 'failure')
        run: |
          echo "üîç Verifying rollback status..."
          # Verify backend is running
          if systemctl is-active --quiet safevote-backend; then
            echo "‚úÖ Backend service is running"
          else
            echo "‚ùå Backend service is not running after rollback"
            exit 1
          fi
          
          # Add any additional verification steps here
          echo "‚úÖ Rollback verification complete"

      - name: Notify Rollback
        if: always() && (needs.deploy-backend.result == 'failure' || needs.deploy-frontend.result == 'failure')
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_COLOR: '#ff0000'
          SLACK_TITLE: 'üö® SafeVote Rollback Triggered'
          SLACK_MESSAGE: |
            *Environment*: ${{ env.ENVIRONMENT }}
            *Failed Job*: ${{ contains(needs.*.result, 'failure') && 'Multiple' || (needs.deploy-backend.result == 'failure' && 'Backend' || (needs.deploy-frontend.result == 'failure' && 'Frontend' || 'Validation')) }}
            *Commit*: ${{ github.sha }}
            *Run URL*: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
            *Rollback Status*: ${{ steps.verify-rollback.outcome == 'success' && '‚úÖ Successful' || '‚ùå Failed' }}
            *Next Steps*: Please investigate the failure and redeploy when fixed
